<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta charset="UTF-8">

  <!-- レスポンシブ対応 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- サイトタイトル -->
<title>Fortnite Events Browser</title>

  <!-- サイトの説明（検索エンジン用） -->
<meta name="description" content="Fortniteの大会スケジュールとカレンダーを確認できるブラウザツールです。">

  <!-- キーワード（SEO用） -->
<meta name="keywords" content="Fortnite, フォートナイト, 大会, トーナメント, カレンダー, FNCS">

  <!-- 作者 -->
<meta name="author" content="MeroFN">

  <!-- テーマカラー（モバイルブラウザでのUIカラー） -->
<meta name="theme-color" content="#1f8ef1">

  <!-- Open Graph (SNSでのシェア用) -->
<meta property="og:title" content="Fortnite Events Browser">
<meta property="og:description" content="Fortniteの大会スケジュールを一覧で表示。リマインダーや通知機能付き。">
<meta property="og:image" content="https://fnevents.merofn.com/assets/og-image.png">
<meta property="og:url" content="https://fnevents.merofn.com/browser/index.html">
<meta property="og:type" content="website">

  <!-- Twitterカード -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Fortnite Events Browser">
<meta name="twitter:description" content="Fortnite大会スケジュールを確認！通知やリマインダー機能も。">
<meta name="twitter:image" content="https://fnevents.merofn.com/assets/og-image.png">

<title>Fortnite Tournament Calendar — Browser</title>
<style>
:root {
  --bg: #f3f4f6;
  --panel: #ffffff;
  --text: #0f172a;
  --muted: #6b7280;
  --accent: #1da1f2; /* Twitterブルー */
  --border: #e5e7eb;
  --radius: 12px;
  --shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
}

[data-theme="dark"] {
  --bg: #0d1117; /* Discord/VSCode系のダーク */
  --panel: #161b22;
  --text: #e6edf3;
  --muted: #9ca3af;
  --accent: #5865f2; /* Discordブルー */
  --border: #30363d;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

body {
  font-family: 'Inter', 'Noto Sans JP', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 0;
  transition: background 0.3s, color 0.3s;
}

/* ヘッダー（Twitter/Discord風） */
header {
  background: var(--panel);
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: var(--shadow);
}
header h1 {
  margin: 0;
  font-size: 1.4rem;
  color: var(--accent);
  font-weight: 700;
  letter-spacing: 0.5px;
}
header nav a {
  margin-left: 20px;
  color: var(--muted);
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s;
}
header nav a:hover {
  color: var(--accent);
}

/* コンテナ（カード一覧） */
.container {
  max-width: 960px;
  margin: 30px auto;
  padding: 0 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* イベントカード（Twitterのタイムライン風） */
.card {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  transition: transform 0.15s, box-shadow 0.2s;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}
.card h2 {
  font-size: 1.2rem;
  margin: 0 0 6px;
  color: var(--accent);
}
.card p {
  font-size: 0.95rem;
  color: var(--muted);
  margin: 0 0 10px;
}
.card .date {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text);
  margin-top: 6px;
}

/* ボタン（Twitter風） */
.btn {
  margin-top: 14px;
  padding: 8px 14px;
  background: var(--accent);
  color: #fff;
  border-radius: 9999px; /* pill形状 */
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  display: inline-block;
  transition: background 0.2s, transform 0.1s;
}
.btn:hover {
  background: #0d8ddc;
  transform: scale(1.05);
}

/* テーマ切替ボタン（右下フローティング） */
.theme-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  font-size: 1.2rem;
  transition: background 0.3s, transform 0.2s;
}
.theme-toggle:hover {
  background: #0d8ddc;
  transform: scale(1.1);
}

</style>
</head>
<body>
<div class="wrap">
<header>
<h1>Fortnite Tournament Calendar</h1>
<div class="controls">
<button id="req-perm">通知を許可</button>
<button id="refresh" class="btn-ghost">再取得</button>
</div>
</header>

<div class="layout">
  <!-- 左側：カレンダー -->
  <aside class="panel sidebar">
    <div class="month">
      <div>
        <div id="monthTitle" class="muted-small">--</div>
        <div id="monthRange" class="muted">--</div>
      </div>
      <div>
        <button id="prevMonth" class="btn-ghost">◀</button>
        <button id="nextMonth" class="btn-ghost">▶</button>
      </div>
    </div>
    <div class="calendar" id="calendarGrid"></div>
  </aside>

  <!-- 右側：イベント詳細 -->
  <main class="panel">
    <div class="toolbar">
      <div>
        <div class="small muted-small">イベント数</div>
        <div id="eventCount" class="title">0</div>
      </div>
      <div class="small muted-small">
        注意: ブラウザを閉じるとページ内タイマーは停止します。永続通知はServiceWorker+Pushが必要です。
      </div>
    </div>
    <div id="events" class="event-list"></div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="small muted-small">リマインダー保存: localStorage</div>
      <button id="clearReminders" class="btn-ghost">リセット</button>
    </div>
  </main>
</div>
</div>

<script>
const EVENTS_URL='https://fljpapi.vigyanfv.workers.dev/tournamentlist?region=ASIA&platform=Windows&cosmeticsinfo=true';
const REMIND_BEFORE_MIN=15;

function fmtDateTime(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}

let events=[]; 
let viewDate=new Date();
const scheduledTimers={};

function loadReminders(){try{return JSON.parse(localStorage.getItem('fn_reminders')||'[]')}catch(e){return []}}
function saveReminders(arr){localStorage.setItem('fn_reminders',JSON.stringify(arr))}
function addReminder(r){const all=loadReminders();all.push(r);saveReminders(all);}
function removeReminder(id){const all=loadReminders().filter(x=>x.id!==id);saveReminders(all);}

async function requestPermission(){
  if(!('Notification' in window)) return alert('このブラウザは Notifications をサポートしていません');
  const p=await Notification.requestPermission();
  document.getElementById('req-perm').textContent=(p==='granted')?'通知許可済み':'通知許可';
  return p;
}

function scheduleReminder(rem){
  const now=Date.now();
  const fireAt=new Date(rem.timeUtc).getTime()-(rem.whenMinutesBefore||REMIND_BEFORE_MIN)*60000;
  if(fireAt<=now)return;
  const timeout=fireAt-now;
  if(timeout>2147483640)return;
  const tid=setTimeout(()=>{
    if('serviceWorker' in navigator){
      navigator.serviceWorker.ready.then(reg=>reg.showNotification(rem.title,{body:`開始 ${rem.whenMinutesBefore} 分前`}));
    }else{
      new Notification(rem.title,{body:`開始 ${rem.whenMinutesBefore} 分前`});
    }
    removeReminder(rem.id);
    delete scheduledTimers[rem.id];
    renderEvents();
  },timeout);
  scheduledTimers[rem.id]=tid;
}

function restoreAndSchedule(){loadReminders().forEach(r=>scheduleReminder(r));}

async function fetchEvents(){
  try{
    const res=await fetch(EVENTS_URL,{cache:'no-store'});
    if(!res.ok)throw new Error('fetch failed '+res.status);
    const data=await res.json();
    const added=new Set();
    events=[];
    data.events.forEach(ev=>{
      ev.eventWindows.forEach(win=>{
        if(added.has(win.eventWindowId))return;
        added.add(win.eventWindowId);
        events.push({
          id:win.eventWindowId,
          title:ev.eventGroup+' '+(win.metadata.RoundType||''),
          startUtc:win.beginTime,
          endUtc:win.endTime,
          region:ev.regions?ev.regions.join(','):'Asia',
          meta:win.metadata||null
        });
      });
    });
    renderCalendar();
    renderEvents();
  }catch(e){console.error(e);alert('イベントの取得に失敗しました。');}
}

function renderCalendar(){
  const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
  const start=new Date(viewDate.getFullYear(),viewDate.getMonth(),1);
  const startWeekDay=start.getDay();
  const firstCell=addDays(start,-startWeekDay);

  for(let i=0;i<42;i++){
    const d=addDays(firstCell,i);
    const cell=document.createElement('div'); cell.className='day';
    if(d.getMonth()!==viewDate.getMonth()) cell.style.opacity=0.4;

    const dateDiv=document.createElement('div'); dateDiv.className='date';
    dateDiv.textContent=d.getDate(); cell.appendChild(dateDiv);

    const eventsOnDay=events.filter(ev=>new Date(ev.startUtc).toDateString()===d.toDateString());
    if(eventsOnDay.length){
      const evWrap=document.createElement('div'); evWrap.className='events';
      eventsOnDay.slice(0,2).forEach(ev=>{
        const e=document.createElement('div');
        e.textContent='• ' + ev.title;
        evWrap.appendChild(e);
      });
      cell.appendChild(evWrap);
    }

    if(d.toDateString()===new Date().toDateString()) cell.classList.add('today');

    // 日付クリックで右側イベント詳細表示
    cell.addEventListener('click',()=>renderEvents(eventsOnDay));

    grid.appendChild(cell);
  }

  document.getElementById('monthTitle').textContent=viewDate.toLocaleString('default',{month:'long',year:'numeric'});
  document.getElementById('monthRange').textContent=
    `${new Date(viewDate.getFullYear(),viewDate.getMonth(),1).toLocaleDateString()} – ${new Date(viewDate.getFullYear(),viewDate.getMonth()+1,0).toLocaleDateString()}`;
}

function renderEvents(list=null){
  const container=document.getElementById('events'); container.innerHTML='';
  const sorted=list ? [...list] : [...events];
  sorted.sort((a,b)=>new Date(a.startUtc)-new Date(b.startUtc));
  document.getElementById('eventCount').textContent=sorted.length;

  sorted.forEach(ev=>{
    const card=document.createElement('div'); card.className='event-card';
    const left=document.createElement('div'); left.className='meta';
    const t=document.createElement('div'); t.className='title'; t.textContent=ev.title;
    const when=document.createElement('div'); when.className='when';
    when.textContent=fmtDateTime(new Date(ev.startUtc)) + (ev.region?` · ${ev.region}`:'');
    left.appendChild(t); left.appendChild(when);

    const right=document.createElement('div');
    const subscribe=document.createElement('button'); subscribe.textContent='リマインド';
    subscribe.onclick=async ()=>{
      if(Notification.permission!=='granted'){ const p=await requestPermission(); if(p!=='granted') return; }
      const id='rem_'+(ev.id||Math.random().toString(36).slice(2));
      addReminder({id,title:ev.title,timeUtc:ev.startUtc,whenMinutesBefore:REMIND_BEFORE_MIN});
      scheduleReminder({id,title:ev.title,timeUtc:ev.startUtc,whenMinutesBefore:REMIND_BEFORE_MIN});
      renderEvents(list);
      subscribe.textContent='セット済み'; subscribe.disabled=true;
    };

    const existing=loadReminders().find(r=>r.timeUtc===ev.startUtc && r.title===ev.title);
    if(existing){subscribe.textContent='セット済み'; subscribe.disabled=true;}

    right.appendChild(subscribe);
    card.appendChild(left); card.appendChild(right);
    container.appendChild(card);
  });
}

document.getElementById('prevMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1);renderCalendar();});
document.getElementById('nextMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1);renderCalendar();});
document.getElementById('refresh').addEventListener('click',fetchEvents);
document.getElementById('req-perm').addEventListener('click',requestPermission);
document.getElementById('clearReminders').addEventListener('click',()=>{
  if(confirm('全てのリマインダーを削除しますか？')){
    localStorage.removeItem('fn_reminders');
    Object.values(scheduledTimers).forEach(t=>clearTimeout(t));
    for(const k in scheduledTimers) delete scheduledTimers[k];
    renderEvents();
  }
});

(function(){restoreAndSchedule();fetchEvents().catch(()=>{});renderCalendar();renderEvents();})();

// Service Worker registration
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW registered')).catch(err=>console.warn('SW failed',err));
}
</script>
</body>
</html>
