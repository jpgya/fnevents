<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fortnite Tournament Calendar — Browser</title>
<style>
:root{
  --bg:#f3f7fb; --panel:#ffffff; --muted:#6b7280; --accent:#1f8ef1; --border:#e6eef9; --radius:12px;
  --shadow:0 8px 24px rgba(15,23,42,0.06);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
}
html,body{
  height:100%;
  margin:0;
  background:linear-gradient(180deg,var(--bg),#eaf3fb);
}
.wrap{
  max-width:1100px;
  margin:28px auto;
  padding:20px;
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
}
h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;align-items:center}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.btn-ghost{
  background:transparent;
  color:var(--accent);
  border:1px solid rgba(31,142,241,0.12);
}
.layout{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:18px;
}
.panel{
  background:var(--panel);
  border-radius:var(--radius);
  padding:14px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}
.sidebar .month{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.calendar .day{
  padding:8px;
  border-radius:8px;
  text-align:center;
  background:linear-gradient(180deg,#fff,#fbfdff);
  border:1px solid #f0f6fb;
  min-height:70px; /* 高さを確保してイベントが潰れない */
}
.day .date{font-weight:600}
.day .events{
  margin-top:6px;
  font-size:11px;
  text-align:left;
  display:flex;
  flex-direction:column;
  gap:2px;
  overflow:hidden; /* はみ出すイベントを隠す */
}
.day .events div{
  white-space:nowrap;
  text-overflow:ellipsis;
  overflow:hidden;
}
.today{box-shadow:0 0 0 2px rgba(31,142,241,0.12)}
.toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.event-list{
  display:grid;
  gap:10px;
  overflow-y:auto;
  max-height:70vh; /* 長いリストでもスクロール可能 */
}
.event-card{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-radius:10px;
  background:linear-gradient(180deg,#ffffff,#fbfdff);
  border:1px solid #f0f6fb;
  flex-shrink:0;
  word-break:break-word; /* 文字が潰れない */
}
.meta{font-size:13px}
.title{font-weight:700}
.when{color:var(--muted);font-size:13px}
.small{font-size:13px}
.muted-small{color:var(--muted)}
footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
@media (max-width:900px){
  .layout{grid-template-columns:1fr}
  .sidebar{order:2}
}
</style>
</head>
<body>
<div class="wrap">
<header>
<h1>Fortnite Tournament Calendar</h1>
<div class="controls">
<button id="req-perm">通知を許可</button>
<button id="refresh" class="btn-ghost">再取得</button>
</div>
</header>

<div class="layout">
<aside class="panel sidebar">
<div class="month">
<div>
<div id="monthTitle" class="muted-small">--</div>
<div id="monthRange" class="muted">--</div>
</div>
<div>
<button id="prevMonth" class="btn-ghost">◀</button>
<button id="nextMonth" class="btn-ghost">▶</button>
</div>
</div>

<div class="calendar" id="calendarGrid"></div>

<div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
<div class="small muted-small">リマインダー保存: localStorage</div>
<button id="clearReminders" class="btn-ghost">リセット</button>
</div>
</aside>

<main class="panel">
<div class="toolbar">
<div>
<div class="small muted-small">イベント数</div>
<div id="eventCount" class="title">0</div>
</div>
<div class="small muted-small">注意: ブラウザを閉じるとページ内タイマーは停止します。永続通知はサービスワーカー+Pushが必要です。</div>
</div>
<div id="events" class="event-list"></div>
</main>
</div>
</div>

<script>
const EVENTS_URL='https://fljpapi.vigyanfv.workers.dev/tournamentlist?region=ASIA&platform=Windows&cosmeticsinfo=true';
const REMIND_BEFORE_MIN=15;

function fmtDateTime(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}

let events=[]; // id -> event
let viewDate=new Date();
const scheduledTimers={};

function loadReminders(){try{return JSON.parse(localStorage.getItem('fn_reminders')||'[]')}catch(e){return []}}
function saveReminders(arr){localStorage.setItem('fn_reminders',JSON.stringify(arr))}
function addReminder(r){const all=loadReminders();all.push(r);saveReminders(all);}
function removeReminder(id){const all=loadReminders().filter(x=>x.id!==id);saveReminders(all);}

async function requestPermission(){if(!('Notification'in window))return alert('このブラウザは Notifications をサポートしていません');const p=await Notification.requestPermission();document.getElementById('req-perm').textContent=(p==='granted')?'通知許可済み':'通知許可';return p;}

function scheduleReminder(rem){
  const now=Date.now();
  const fireAt=new Date(rem.timeUtc).getTime()-(rem.whenMinutesBefore||REMIND_BEFORE_MIN)*60000;
  if(fireAt<=now)return;
  const timeout=fireAt-now;
  if(timeout>2147483640)return;
  const tid=setTimeout(()=>{
    if('serviceWorker' in navigator){
      navigator.serviceWorker.ready.then(reg=>reg.showNotification(rem.title,{body:`開始 ${rem.whenMinutesBefore} 分前`}));
    }else{
      new Notification(rem.title,{body:`開始 ${rem.whenMinutesBefore} 分前`});
    }
    removeReminder(rem.id);
    delete scheduledTimers[rem.id];
    render();
  },timeout);
  scheduledTimers[rem.id]=tid;
}

function restoreAndSchedule(){loadReminders().forEach(r=>scheduleReminder(r));}

async function fetchEvents(){
  try{
    const res=await fetch(EVENTS_URL,{cache:'no-store'});
    if(!res.ok)throw new Error('fetch failed '+res.status);
    const data=await res.json();
    const added=new Set();
    events=[];
    data.events.forEach(ev=>{
      ev.eventWindows.forEach(win=>{
        if(added.has(win.eventWindowId))return;
        added.add(win.eventWindowId);
        events.push({
          id:win.eventWindowId,
          title:ev.eventGroup+' '+(win.metadata.RoundType||''),
          startUtc:win.beginTime,
          endUtc:win.endTime,
          region:ev.regions?ev.regions.join(','):'Asia',
          meta:win.metadata||null
        });
      });
    });
    render();
  }catch(e){console.error(e);alert('イベントの取得に失敗しました。');}
}

function renderCalendar(){
  const grid=document.getElementById('calendarGrid');grid.innerHTML='';
  const start=new Date(viewDate.getFullYear(),viewDate.getMonth(),1);
  const startWeekDay=start.getDay();
  const firstCell=addDays(start,-startWeekDay);
  for(let i=0;i<42;i++){
    const d=addDays(firstCell,i);
    const cell=document.createElement('div');cell.className='day';
    if(d.getMonth()!==viewDate.getMonth())cell.style.opacity=0.45;
    const dateDiv=document.createElement('div');dateDiv.className='date';dateDiv.textContent=d.getDate();
    cell.appendChild(dateDiv);
    const eventsOnDay=events.filter(ev=>new Date(ev.startUtc).toDateString()===d.toDateString()).slice(0,3);
    if(eventsOnDay.length){
      const evWrap=document.createElement('div');evWrap.className='events';
      eventsOnDay.forEach(ev=>{
        const e=document.createElement('div');e.textContent='• '+ev.title;e.title=ev.title;e.style.fontSize='12px';e.style.whiteSpace='nowrap';e.style.overflow='hidden';e.style.textOverflow='ellipsis';
        evWrap.appendChild(e);
      });
      cell.appendChild(evWrap);
    }
    if(d.toDateString()===new Date().toDateString())cell.classList.add('today');
    grid.appendChild(cell);
  }
  document.getElementById('monthTitle').textContent=viewDate.toLocaleString('default',{month:'long',year:'numeric'});
  document.getElementById('monthRange').textContent=`${new Date(viewDate.getFullYear(),viewDate.getMonth(),1).toLocaleDateString()} – ${new Date(viewDate.getFullYear(),viewDate.getMonth()+1,0).toLocaleDateString()}`;
}

function renderEvents(){
  const container=document.getElementById('events');container.innerHTML='';
  const sorted=[...new Map(events.map(e=>[e.id,e])).values()].sort((a,b)=>new Date(a.startUtc)-new Date(b.startUtc));
  document.getElementById('eventCount').textContent=sorted.length;
  sorted.forEach(ev=>{
    const card=document.createElement('div');card.className='event-card';
    const left=document.createElement('div');left.className='meta';
    const t=document.createElement('div');t.className='title';t.textContent=ev.title;
    const when=document.createElement('div');when.className='when';when.textContent=fmtDateTime(new Date(ev.startUtc))+(ev.region?` · ${ev.region}`:'');
    left.appendChild(t);left.appendChild(when);

    const right=document.createElement('div');
    const subscribe=document.createElement('button');subscribe.textContent='リマインド';
    subscribe.onclick=async ()=>{
      if(Notification.permission!=='granted'){const p=await requestPermission();if(p!=='granted')return;}
      const id='rem_'+(ev.id||Math.random().toString(36).slice(2));
      const rem={id,title:ev.title,timeUtc:ev.startUtc,whenMinutesBefore:REMIND_BEFORE_MIN};
      addReminder(rem);scheduleReminder(rem);render();
      subscribe.textContent='セット済み';subscribe.disabled=true;
    };

    const existing=loadReminders().find(r=>r.timeUtc===ev.startUtc && r.title===ev.title);
    if(existing){subscribe.textContent='セット済み';subscribe.disabled=true;}

    right.appendChild(subscribe);
    card.appendChild(left);card.appendChild(right);
    container.appendChild(card);
  });
}

function render(){renderCalendar();renderEvents();}

document.getElementById('prevMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1);render();});
document.getElementById('nextMonth').addEventListener('click',()=>{viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1);render();});
document.getElementById('refresh').addEventListener('click',fetchEvents);
document.getElementById('req-perm').addEventListener('click',requestPermission);
document.getElementById('clearReminders').addEventListener('click',()=>{if(confirm('全てのリマインダーを削除しますか？')){localStorage.removeItem('fn_reminders');Object.values(scheduledTimers).forEach(t=>clearTimeout(t));for(const k in scheduledTimers)delete scheduledTimers[k];render();}});

(function(){restoreAndSchedule();fetchEvents().catch(()=>{});render();})();

// --- Service Worker registration for notifications ---
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW registered')).catch(err=>console.warn('SW failed',err));
}
</script>
</body>
</html>
